#!/bin/bash
# FerroOS Compiler - Compila archivos .lua a .wpk
# Uso: fos -cP archivo.lua

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDK_DIR="$(cd "$SCRIPT_DIR/../sdk" && pwd)"

show_help() {
    cat << EOF
FerroOS Compiler v$VERSION
Compila archivos Lua a paquetes WPK para FerroOS

Uso:
  fos -cP <archivo.lua>     Compilar a producci√≥n
  fos -c <archivo.lua>      Compilar (debug)
  fos -h                    Mostrar ayuda

Ejemplo:
  fos -cP myapp.lua         ‚Üí Genera build_wpk/myapp.wpk

EOF
}

compile_lua_to_wpk() {
    local LUA_FILE="$1"
    local PRODUCTION="$2"
    
    if [ ! -f "$LUA_FILE" ]; then
        echo "‚ùå Error: No se encontr√≥ $LUA_FILE"
        exit 1
    fi
    
    local APP_NAME=$(basename "$LUA_FILE" .lua)
    local ABS_LUA=$(realpath "$LUA_FILE")
    local INITIAL_CWD=$(pwd)
    local PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
    local OUTPUT_DIR="$PROJECT_ROOT/build_wpk"
    
    mkdir -p "$OUTPUT_DIR"
    
    echo "üì¶ Compilando $LUA_FILE ‚Üí build_wpk/${APP_NAME}.wpk"
    
    # Copiar Lua al SDK
    cp "$ABS_LUA" "$SDK_DIR/src/assets/app.lua"
    
    # Compilar con SDK
    cd "$SDK_DIR"
    if [ "$PRODUCTION" = "true" ]; then
        zig build -Doptimize=ReleaseFast wasm > /dev/null 2>&1
    else
        zig build wasm > /dev/null 2>&1
    fi
    
    if [ ! -f "zig-out/bin/app.wasm" ]; then
        echo "‚ùå Error de compilaci√≥n"
        cd "$INITIAL_CWD"
        exit 1
    fi
    
    # Crear WPK
    local TMP=$(mktemp -d)
    mkdir -p "$TMP/assets"
    cp zig-out/bin/app.wasm "$TMP/"
    cp "$ABS_LUA" "$TMP/assets/app.lua"
    
    cat > "$TMP/manifest.json" << EOF
{
  "name": "$APP_NAME",
  "id": "com.ferroos.$APP_NAME",
  "version": "1.0.0",
  "main": "app.wasm"
}
EOF
    
    HASH=$(sha256sum "$TMP/app.wasm" | awk '{print $1}')
    echo "{\"app.wasm\": \"$HASH\"}" > "$TMP/hashes.json"
    
    (cd "$TMP" && zip -q -r - .) > "$OUTPUT_DIR/${APP_NAME}.wpk"
    
    cd "$INITIAL_CWD"
    rm -rf "$TMP"
    
    echo "‚úÖ build_wpk/${APP_NAME}.wpk creado"
    ls -lh "$OUTPUT_DIR/${APP_NAME}.wpk"
}

# Parse argumentos
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

PRODUCTION=false
LUA_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -cP)
            PRODUCTION=true
            LUA_FILE="$2"
            shift 2
            ;;
        -c)
            LUA_FILE="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            LUA_FILE="$1"
            shift
            ;;
    esac
done

if [ -z "$LUA_FILE" ]; then
    echo "‚ùå Error: Especifica un archivo .lua"
    show_help
    exit 1
fi

compile_lua_to_wpk "$LUA_FILE" "$PRODUCTION"
